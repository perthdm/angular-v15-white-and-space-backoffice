<div class="inner-content">
    <div nz-row>
        <div nz-col [nzSpan]="8">
            <h3 style="margin-bottom:24px; font-size: 24px; font-weight: bold;">คลังสินค้า</h3>
        </div>
        <div nz-col [nzSpan]="16">
            <antd-searchbox placeholder=" ค้นหา Name / Serial / Barcode"></antd-searchbox>
        </div>

        <div class="radio-style" style="max-width: calc(100vw - 58px);">
            <nz-radio-group [(ngModel)]="stockType" nzButtonStyle="solid" nzSize="large"
                (ngModelChange)="handleChangeGroup()" style="width: 100%;">
                <label nz-radio-button nzValue="inventory"> คลังสินค้า </label>
                <label nz-radio-button nzValue="order" style="float :right;">ออเดอร์ </label>
                <label nz-radio-button nzValue="out" style="float :right;">รายการนำออก </label>
                <label nz-radio-button nzValue="in" style="float :right;"> รายการนำเข้า </label>
            </nz-radio-group>
        </div>
    </div>

    <div class="app-content">
        <div nz-row style="padding:0px 20px">
            <div nz-col [nzSpan]="8">
                <h3></h3>
            </div>
            <div nz-col [nzSpan]="24" nzShape="round" style="text-align: right;">
                <nz-space [nzSize]="'small'" *ngIf="stockType === 'inventory'">
                    <button *nzSpaceItem nz-button nzType="primary"
                        style="height: 40px; border-radius: 10px; background-color: #04AA6D; border-color: #04AA6D;"
                        (click)="showModal('import')">
                        <span nz-icon nzType="download" nzTheme="outline" style="font-size:16px"></span>
                        นำเข้าสินค้า
                    </button>

                    <button *nzSpaceItem nz-button nzType="primary" style="height: 40px; border-radius: 10px;"
                        (click)="showModal()">
                        <span nz-icon nzType="plus" nzTheme="outline" style="font-size:16px"></span>
                        เพิ่มสต็อกสินค้า
                    </button>
                </nz-space>
            </div>
        </div>

        <!-- [TABLE] : STOCK -->
        <div nz-row>
            <div nz-col [nzSpan]="24" style="max-width: calc(100vw - 58px);">
                <nz-table *ngIf="stockType === 'inventory'" style="margin:20px 0px; min-height: 300px;" #basicTable
                    [nzData]="stockList" [nzShowPagination]="false" [nzPageSize]="pageLimit">
                    <thead>
                        <tr>
                            <th [nzAlign]="'center'" nzWidth="100px">#</th>
                            <th>ชื่อสต็อกสินค้า</th>
                            <th [nzAlign]="'center'">จำนวนคงเหลือ</th>
                            <th [nzAlign]="'center'">สร้างเมื่อ</th>
                            <th [nzAlign]="'center'">ผู้ทำรายการ</th>
                            <th [nzAlign]="'center'">เครื่องมือ</th>
                            <th [nzAlign]="'center'">รายละเอียด</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let data of basicTable.data ;let index = index" style="cursor: pointer;"
                            (click)="editStock(data)">
                            <td [nzAlign]="'center'">{{ index+1 }}</td>
                            <td> {{ data?.name }}</td>
                            <td [nzAlign]="'center'">{{ data?.amount }}</td>
                            <td [nzAlign]="'center'"> {{ mapDate(data.createdAt) }}</td>
                            <td [nzAlign]="'center'">{{ data?.user_created.username }}</td>
                            <td [nzAlign]="'center'">
                                <button nz-button nzType="primary" nzDanger style="color:white; border-radius: 8px"
                                    (click)="handleSetExport($event,data)">
                                    <span nz-icon nzType="upload" nzTheme="outline" style="font-size: 18px;"></span>
                                    นำออก
                                </button>
                            </td>

                            <td [nzAlign]="'center'">
                                <button nz-button nzType="primary"
                                    style="color:white; border-radius: 8px ; padding: 6px 10px;"
                                    (click)="showModalStockDetail($event,data)">
                                    <span nz-icon nzType="file-sync" nzTheme="outline" style="font-size: 18px;"></span>
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </nz-table>
            </div>
        </div>

        <!-- [TABLE] : IMPORT -->
        <nz-table *ngIf=" stockType ==='in'" style=" margin:20px 0px; min-height: 300px;" #importTrxTable
            [nzData]="lotTrxList" [nzShowPagination]="false" [nzPageSize]="pageLimit">
            <thead>
                <tr>
                    <th>วัน/เดือน/ปี</th>
                    <th>ชื่อสต็อกสินค้า</th>
                    <th [nzAlign]="'center'">จำนวน</th>
                    <th [nzAlign]="'center'">ประเภท</th>
                    <th [nzAlign]="'center'">ผู้ทำรายการ</th>
                    <th>หมายเหตุ</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let data of importTrxTable.data ;let index = index" style="cursor: pointer;">
                    <td> {{ mapDate(data.createdAt) }} </td>
                    <td> {{ data?.lot.stock.name }}</td>
                    <td [nzAlign]="'center'"> {{ data?.amount }} </td>
                    <td [nzAlign]="'center'">
                        <nz-tag [nzColor]="getTagDetail(data.type).color"> {{ getTagDetail(data.type).title }} </nz-tag>
                    </td>
                    <td [nzAlign]="'center'"> {{ data?.user_created?.username }} </td>
                    <td> {{ data?.tracking }}</td>
                </tr>
            </tbody>
        </nz-table>

        <!-- [TABLE] :  EXPORT -->
        <nz-table *ngIf=" stockType ==='out'" style=" margin:20px 0px; min-height: 300px;" #importTrxTable
            [nzData]="lotTrxList" [nzShowPagination]="false" [nzPageSize]="pageLimit">
            <thead>
                <tr>
                    <th>วัน/เดือน/ปี</th>
                    <th>ชื่อสต็อกสินค้า</th>
                    <th [nzAlign]="'center'">จำนวน</th>
                    <th [nzAlign]="'center'">ประเภท</th>
                    <th [nzAlign]="'center'">ผู้ทำรายการ</th>
                    <th>หมายเหตุ</th>
                    <th [nzAlign]="'center'">รายละเอียด</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let data of importTrxTable.data ;let index = index" style="cursor: pointer;">
                    <td> {{ mapDate(data.createdAt) }} </td>
                    <td> {{ data?.lot.stock.name }}</td>
                    <td [nzAlign]="'center'"> {{ data?.amount }} </td>
                    <td [nzAlign]="'center'">
                        <nz-tag [nzColor]="getTagDetail(data.type).color"> {{ getTagDetail(data.type).title }} </nz-tag>
                    </td>
                    <td [nzAlign]="'center'"> {{ data?.user_created?.username }} </td>
                    <td> {{ data?.info }}</td>
                    <td [nzAlign]="'center'">
                        <button *ngIf="data?.tracking.length > 0" nz-button nzType="primary"
                            style="color:white; border-radius: 8px ; padding: 6px 10px;"
                            (click)="showModalExportDetail($event,data)">
                            <span nz-icon nzType="file-sync" nzTheme="outline" style="font-size: 18px;"></span>
                        </button>
                    </td>
                </tr>
            </tbody>
        </nz-table>

        <!-- [TABLE] :  ORDER -->
        <nz-table *ngIf=" stockType ==='order'" style=" margin:20px 0px; min-height: 300px;" #importTrxTable
            [nzData]="lotTrxList" [nzShowPagination]="false" [nzPageSize]="pageLimit">
            <thead>
                <tr>
                    <th>วัน/เดือน/ปี</th>
                    <th>ชื่อสินค้า</th>
                    <th [nzAlign]="'center'">จำนวน</th>
                    <th [nzAlign]="'center'">ประเภท</th>
                    <th [nzAlign]="'center'">ผู้ทำรายการ</th>
                    <th>ORDER ID</th>
                    <th>หมายเหตุ</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let data of importTrxTable.data ;let index = index" style="cursor: pointer;">
                    <td> {{ mapDate(data.createdAt) }} </td>
                    <td> {{ data?.lot.stock.name }}</td>
                    <td [nzAlign]="'center'"> {{ data?.amount }} </td>
                    <td [nzAlign]="'center'">
                        <nz-tag [nzColor]="getTagDetail(data.type).color"> {{ getTagDetail(data.type).title }} </nz-tag>
                    </td>
                    <td [nzAlign]="'center'"> {{ data?.user_created?.username }} </td>
                    <td> {{ data.order.order_id }} </td>
                    <td> {{ data?.tracking }}</td>
                </tr>
            </tbody>
        </nz-table>


        <div style="padding:0px 20px 20px 20px; text-align: right;">
            <nz-pagination [(nzPageIndex)]="page" [nzTotal]="total" [(nzPageSize)]="pageLimit" [nzSimple]="false"
                [nzShowSizeChanger]="true" (nzPageIndexChange)="handleChangePage()"
                (nzPageSizeChange)="onChangePageLimit($event)" [nzShowTotal]="rangeTemplate">
            </nz-pagination>

            <ng-template #rangeTemplate let-range="range" let-total>
                {{ range[0] }}-{{ range[1] }} จากทั้งหมด {{ total }} รายการ
            </ng-template>
        </div>
    </div>

    <!-- [MODAL] : INVENTORY -->
    <nz-modal [(nzVisible)]="isShowModal" nzTitle="{{!isEdit ? 'เพิ่มสต็อกสินค้า' : 'แก้ไขสต็อกสินค้า'}}"
        (nzOnCancel)="closeModal()" (nzOnOk)="handleSubmitData()">
        <ng-container *nzModalContent>
            <h4>ชื่อสต๊อก</h4>
            <input nz-input class="wns-input" placeholder="กรุณากรอกชื่อสต๊อกสินค้า" name="name"
                (change)="onChangeData($event)" [ngModel]="stockData.name" />

            <h4 style="margin-top: 8px;">หมายเหตุ</h4>
            <input nz-input class="wns-input" placeholder="**เว้นว่าง หากไม่ต้องการใส่หมายเหตุ หรือคำอธิบาย" name="info"
                (change)="onChangeData($event)" [ngModel]="stockData.info" />
        </ng-container>
    </nz-modal>


    <!-- [MODAL] : IMPORT -->
    <nz-modal [(nzVisible)]="isShowModalImport" nzTitle="นำเข้าสินค้า" (nzOnCancel)="closeModalImport()"
        (nzOnOk)="handleSubmitImport()" [nzWidth]="'620px'">
        <ng-container *nzModalContent>
            <div *ngIf="stockAllList.length > 0">
                <button nz-button nzType="primary"
                    style="margin-bottom: 15px; float: right; height: 40px; border-radius: 10px;"
                    (click)="addImportItem()">
                    <span nz-icon nzType="plus" nzTheme="outline"></span>
                    เพิ่มรายการ
                </button>

                <nz-table #importItemTable [nzData]="importList" [nzPageSize]="8">
                    <thead>
                        <tr>
                            <th [nzAlign]="'center'">#</th>
                            <th nzWidth="50%">ชื่อสต็อก</th>
                            <th>จำนวน</th>
                            <th [nzAlign]="'center'">ลบ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let data of importItemTable.data ; let index = index" class="editable-row">
                            <td [nzAlign]="'center'">{{ index+1 + ((importItemTable.nzPageIndex-1) * 8) }}</td>
                            <td>
                                <nz-select class="select-style" nzShowSearch nzAllowClear
                                    nzPlaceHolder="เลือกสินค้าที่นำเข้า" [(ngModel)]="data.stock_id" style="width:100%">
                                    <nz-option *ngFor="let current of stockAllList" nzLabel="{{ current.name }}"
                                        [nzDisabled]="!isNotSelected(current)" nzValue="{{ current._id }}"></nz-option>
                                </nz-select>
                            </td>
                            <td [nzAlign]="'center'">
                                <nz-input-number class="wns-input custom-input-number"
                                    style="width:100%; text-align: center;" nzPlaceHolder="กรุณากรอกจำนวน"
                                    [(ngModel)]="data.amount"></nz-input-number>
                            </td>
                            <td [nzAlign]="'center'">
                                <button nz-button nzType="primary" style="margin-bottom: 5px; border-radius: 8px;"
                                    nzDanger (click)="removeImportItem(index)">
                                    <span nz-icon nzType="delete" nzTheme="outline"></span>
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </nz-table>
            </div>
        </ng-container>
    </nz-modal>


    <!-- [MODAL] : EXPORT  nzWidth="720px" -->
    <nz-modal [(nzVisible)]="isShowModalExport" nzTitle="นำสินค้าออก" (nzOnCancel)="closeModalExport()"
        (nzOnOk)="handleSubmitExport()">
        <ng-container *nzModalContent>
            <h4>เลือกล็อตสินค้า</h4>
            <nz-select [(ngModel)]="stockData.lot_id" nzShowSearch nzAllowClear nzPlaceHolder="เลือกสินค้าที่นำเข้า"
                (ngModelChange)="handleRenderTracking($event)" class="select-style" style="width:100%">
                <nz-option *ngFor="let current of importList"
                    nzLabel="{{ current.lot_number }} | ({{current.amount-current.used_amount}}/{{current.amount}})"
                    nzValue="{{ current._id }}"></nz-option>
            </nz-select>

            <h4 style="margin-top: 16px;">สินค้า / จำนวนที่นำออก</h4>
            <nz-select *ngIf="trackingList.length > 0" [nzMaxTagCount]="1" [nzMaxTagPlaceholder]="tagPlaceHolder"
                nzMode="multiple" nzPlaceHolder="กรุณาเลือกสินค้าที่จะนำออก" [(ngModel)]="exportItemSelected"
                class="select-style" style="width:100% ; height: auto;">
                <nz-option *ngFor="let item of trackingList" [nzLabel]="item" [nzValue]="item"></nz-option>
            </nz-select>


            <!--         <div style="width: 100%; text-align: center; display: flex; justify-content: center;">
                <nz-transfer 
                    *ngIf="trackingList.length > 0"
                    [nzListStyle]="{ 'width.px': 315, 'height.px': 400 }" 
                    [nzDataSource]="trackingList" 
                    [nzTitles]="['สินค้าในล็อต', 'สินค้าที่จะนำออก']"
                    (nzSelectChange)="select($event)" 
                    [nzTargetKeys]="exportItemSelected"
                    (nzChange)="change($event)">
                </nz-transfer>
            </div> -->


            <ng-template #tagPlaceHolder let-selectedList>and {{ selectedList.length }} more selected</ng-template>


            <nz-input-number *ngIf="trackingList.length == 0" class="wns-input custom-input-number"
                style="width:100%; text-align: center;" nzPlaceHolder="กรุณากรอกจำนวน"
                [(ngModel)]="stockData.amount"></nz-input-number>


            <h4 style="margin-top: 16px;">หมายเหตุ</h4>
            <input nz-input class="wns-input" placeholder="**เว้นว่าง หากไม่ต้องการใส่หมายเหตุ หรือคำอธิบาย" name="info"
                (change)="onChangeData($event)" [ngModel]="stockData.info" />

        </ng-container>
    </nz-modal>



    <!-- [MODAL] : STOCK DETAIL -->
    <nz-modal [(nzVisible)]="isShowModalStockDetail" nzTitle="รายละเอียดสต็อก" [nzFooter]="null"
        (nzOnCancel)="closeModalDetail()">
        <ng-container *nzModalContent>
            <nz-table #stockDetailTable [nzData]="importList" [nzPageSize]="8">
                <thead>
                    <tr>
                        <th [nzAlign]="'center'">#</th>
                        <th nzWidth="50%">Lot ID</th>
                        <th [nzAlign]="'center'">จำนวนคงเหลือ</th>
                        <th [nzAlign]="'center'">บาร์โค้ด</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let data of stockDetailTable.data ; let index = index" class="editable-row">
                        <td [nzAlign]="'center'">{{ index+1 + ((stockDetailTable.nzPageIndex-1) * 8) }}</td>
                        <td>{{ data.lot_number }}</td>
                        <td [nzAlign]="'center'">{{ data.amount - data.used_amount}}/{{ data.amount }}</td>
                        <td [nzAlign]="'center'">
                            <button (click)="printBarcode(data)"
                                [style]="data.is_print ? 'background: #04AA6D; border: 1px solid #04AA6D;': ''"
                                nz-button nzType="primary" style="color:white; border-radius: 8px ; padding: 6px 10px;">
                                <span nz-icon nzType="barcode" nzTheme="outline" style="font-size: 18px;"></span>
                            </button>
                        </td>
                    </tr>
                </tbody>
            </nz-table>
        </ng-container>
    </nz-modal>


    <!-- [MODAL] : EXPORT DETAIL -->
    <nz-modal [(nzVisible)]="isShowModalExportDetail" nzTitle="รายละเอียดการนำออก" [nzFooter]="null"
        (nzOnCancel)="closeModalExportDetail()">
        <ng-container *nzModalContent>
            <nz-table #stockDetailTable [nzData]="exportItemSelected" [nzPageSize]="8">
                <thead>
                    <tr>
                        <th [nzAlign]="'center'">#</th>
                        <th nzWidth="50%">Tracking ID</th>
                        <th [nzAlign]="'center'">จำนวน</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let data of stockDetailTable.data ; let index = index" class="editable-row">
                        <td [nzAlign]="'center'">{{ index+1 + ((stockDetailTable.nzPageIndex-1) * 8) }}</td>
                        <td>{{ data }}</td>
                        <td [nzAlign]="'center'">1</td>
                    </tr>
                </tbody>
            </nz-table>
        </ng-container>
    </nz-modal>
</div>